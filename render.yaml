# render.yaml - Configuration robuste pour HEXGATE WhatsApp
services:
  - type: web
    name: hexgate-whatsapp
    env: node
    plan: free
    region: frankfurt
    buildCommand: |
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘   ğŸ› ï¸  HEXGATE BUILD PROCESS           â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "ğŸ“¦ Ã‰tape 1: Nettoyage..."
      rm -rf node_modules || true
      rm -f package-lock.json || true
      
      echo "ğŸ“¦ Ã‰tape 2: Installation des dÃ©pendances de base..."
      npm install express@4.18.2 cors@2.8.5 body-parser@1.20.2 chalk@5.3.0 --no-save --legacy-peer-deps
      
      echo "ğŸ“¦ Ã‰tape 3: Tentative d'installation de Baileys..."
      if npm install @whiskeysockets/baileys@6.4.0 --no-save --legacy-peer-deps 2>/dev/null; then
        echo "âœ… Baileys installÃ© avec succÃ¨s"
      else
        echo "âš ï¸  Baileys Ã©chouÃ©, installation alternative..."
        npm install https://registry.npmjs.org/@whiskeysockets/baileys/-/baileys-6.4.0.tgz --no-save --legacy-peer-deps || true
      fi
      
      echo "ğŸ“¦ Ã‰tape 4: Installation de pino..."
      npm install pino@8.15.4 --no-save --legacy-peer-deps || true
      
      echo "ğŸ“¦ Ã‰tape 5: Installation des dÃ©pendances restantes..."
      npm install dotenv@16.3.1 fs-extra@11.1.1 --no-save --legacy-peer-deps
      
      echo ""
      echo "âœ… Construction terminÃ©e avec succÃ¨s!"
      echo ""
      
    startCommand: |
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘   ğŸš€  HEXGATE WHATSAPP SERVER        â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "ğŸ“Š Environnement:"
      echo "   PORT: $PORT"
      echo "   NODE_ENV: production"
      echo "   REGION: frankfurt"
      echo ""
      echo "ğŸ” VÃ©rification des dÃ©pendances..."
      node -e "
        try {
          require('express');
          console.log('âœ… Express: OK');
        } catch(e) { console.log('âŒ Express: MANQUANT'); }
        
        try {
          require('@whiskeysockets/baileys');
          console.log('âœ… Baileys: OK');
        } catch(e) { 
          console.log('âš ï¸  Baileys: NON DISPONIBLE');
          console.log('   Mode dÃ©mo activÃ©');
        }
        
        try {
          require('pino');
          console.log('âœ… Pino: OK');
        } catch(e) { console.log('âš ï¸  Pino: NON DISPONIBLE'); }
      "
      echo ""
      echo "ğŸŒ DÃ©marrage du serveur..."
      node server.js
    
    healthCheckPath: /health
    autoDeploy: true
    
    # RedÃ©marrage automatique en cas de crash
    restartPolicyType: ON_FAILURE
    restartPolicyMaxRetries: 10
    
    # Ressources
    disk:
      name: sessions
      mountPath: /opt/render/project/src/sessions
      sizeGB: 1
    
    # Variables d'environnement
    envVars:
      - key: NODE_VERSION
        value: 20.11.0
      - key: NODE_ENV
        value: production
      - key: DISABLE_RENDER_AUTO_INSTALL
        value: "true"
      - key: RENDER
        value: "true"
      - key: PORT
        value: 3000
      - key: SESSIONS_DIR
        value: /opt/render/project/src/sessions
      - key: MAX_SESSIONS
        value: "10"
      - key: SESSION_TIMEOUT_MINUTES
        value: "480"
    
    # Plan gratuit avec optimisations
    plan: free
    numInstances: 1
    
    # Domaine personnalisÃ© (optionnel)
    # domains:
    #   - hexgate-whatsapp.onrender.com
    
    # Headers de sÃ©curitÃ©
    headers:
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block

# Volumes persistants (pour les sessions)
# Note: Non disponible sur le plan gratuit, mais configurÃ© pour l'avenir
volumes:
  - name: sessions-volume
    mountPath: /opt/render/project/src/sessions
    sizeGB: 1
